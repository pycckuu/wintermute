name: Dependency security audit

on:
  push:
    branches: [main]
  pull_request:
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTC_WRAPPER: "sccache"
  # Use git CLI for fetching (required for SSH auth with private repos in isolated env)
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  # COMPLETE ISOLATION: Each job gets its own environment
  CARGO_TARGET_DIR: /tmp/cargo-target-${{ github.run_id }}-${{ github.job }}
  CARGO_HOME: /tmp/cargo-home-${{ github.run_id }}-${{ github.job }}
  RUSTUP_HOME: /tmp/rustup-${{ github.run_id }}-${{ github.job }}
  SCCACHE_DIR: /tmp/sccache-${{ github.run_id }}-${{ github.job }}

jobs:
  dependency-audit:
    # TODO(template): update to your runner name
    runs-on: [self-hosted, rust-template]
    timeout-minutes: 10
    permissions:
      contents: read
      checks: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup isolated Rust environment
        run: |
          mkdir -p "$CARGO_HOME" "$RUSTUP_HOME" "$SCCACHE_DIR"
          echo "$CARGO_HOME/bin" >> $GITHUB_PATH
      - uses: dtolnay/rust-toolchain@stable
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          prefix-key: "v1-rust-${{ github.job }}"

      - name: Install cargo-deny
        run: |
          if ! command -v cargo-deny &> /dev/null; then
            RUSTC_WRAPPER= cargo install cargo-deny --locked
          fi

      - name: Run security audit
        run: cargo +stable deny check
